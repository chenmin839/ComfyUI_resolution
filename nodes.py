import torch

class AspectRatioLatentImage:
    """
    ComfyUIæ’ä»¶ï¼šå›¾åƒæ¯”ä¾‹é€‰æ‹©å™¨
    æä¾›é¢„è®¾çš„å›¾åƒåˆ†è¾¨ç‡é€‰æ‹©ï¼ŒåŒ…æ‹¬SDæ¨¡å‹å¸¸ç”¨å°ºå¯¸ã€ç”µè„‘åˆ†è¾¨ç‡å’Œç§»åŠ¨è®¾å¤‡åˆ†è¾¨ç‡
    åŒæ—¶æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å®½åº¦å’Œé«˜åº¦è¾“å…¥
    """
    
    def __init__(self):
        self.device = "cpu"

    @classmethod
    def INPUT_TYPES(s):
        # é¢„è®¾åˆ†è¾¨ç‡åˆ—è¡¨ï¼ŒæŒ‰åˆ†ç±»ç»„ç»‡
        resolution_presets = [
            # === AIå›¾åƒç”Ÿæˆä¸“ç”¨åˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === SD 1.5 åˆ†è¾¨ç‡ (512åŸºç¡€) ===",
            "512x512 (1:1) SD1.5 æ­£æ–¹å½¢",
            "512x768 (2:3) SD1.5 ç«–ç‰ˆ",
            "768x512 (3:2) SD1.5 æ¨ªç‰ˆ", 
            "512x704 (8:11) SD1.5 å¸¸ç”¨ç«–ç‰ˆ",
            "704x512 (11:8) SD1.5 å¸¸ç”¨æ¨ªç‰ˆ",
            "512x576 (8:9) SD1.5 ä¸­ç­‰ç«–ç‰ˆ",
            "576x512 (9:8) SD1.5 ä¸­ç­‰æ¨ªç‰ˆ",
            "512x896 (4:7) SD1.5 ç«–å±",
            "896x512 (7:4) SD1.5 æ¨ªå±",
            "448x512 (7:8) SD1.5 çª„ç«–ç‰ˆ",
            "512x448 (8:7) SD1.5 å®½æ¨ªç‰ˆ",
            "640x512 (5:4) SD1.5 æ¥è¿‘4:3",
            "512x640 (4:5) SD1.5 æ¥è¿‘3:4",
            "384x512 (3:4) SD1.5 æ ‡å‡†ç«–ç‰ˆ",
            "512x384 (4:3) SD1.5 æ ‡å‡†æ¨ªç‰ˆ",
            "512x614 (5:6) SD1.5 æ¥è¿‘æ­£æ–¹å½¢ç«–ç‰ˆ",
            "614x512 (6:5) SD1.5 æ¥è¿‘æ­£æ–¹å½¢æ¨ªç‰ˆ",
            "768x768 (1:1) SD1.5 å¤§æ­£æ–¹å½¢",
            
            "ğŸŸ¢ === SDXL åˆ†è¾¨ç‡ (1024åŸºç¡€) ===",
            "1024x1024 (1:1) SDXL æ­£æ–¹å½¢",
            "832x1216 (2:3) SDXL ç«–ç‰ˆ",
            "1216x832 (3:2) SDXL æ¨ªç‰ˆ",
            "1024x1280 (4:5) SDXL æ ‡å‡†ç«–ç‰ˆ",
            "1280x1024 (5:4) SDXL æ ‡å‡†æ¨ªç‰ˆ",
            "1024x1408 (8:11) SDXL å¸¸ç”¨ç«–ç‰ˆ",
            "1408x1024 (11:8) SDXL å¸¸ç”¨æ¨ªç‰ˆ",
            "768x1344 (4:7) SDXL ç«–å±",
            "1344x768 (7:4) SDXL æ¨ªå±",
            "896x1152 (7:9) SDXL ç«–ç‰ˆæ¯”ä¾‹",
            "1152x896 (9:7) SDXL æ¨ªç‰ˆæ¯”ä¾‹",
            "896x1024 (7:8) SDXL çª„ç«–ç‰ˆ",
            "1024x896 (8:7) SDXL å®½æ¨ªç‰ˆ",
            "1024x1536 (2:3) SDXL é«˜ç«–ç‰ˆ",
            "1536x1024 (3:2) SDXL å®½æ¨ªç‰ˆ",
            
            # === æ¡Œé¢ç”µè„‘åˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === æ¡Œé¢ç”µè„‘åˆ†è¾¨ç‡ ===",
            "1920x1080 (16:9) Full HD",
            "2560x1440 (16:9) 2K QHD",
            "3840x2160 (16:9) 4K UHD",
            "1366x768 (16:9) ç¬”è®°æœ¬æœ€å¸¸è§",
            "1280x720 (16:9) HD",
            "1600x900 (16:9) å®½å±",
            "1920x1200 (16:10) ä¸“ä¸šæ˜¾ç¤ºå™¨",
            "2560x1600 (16:10) é«˜ç«¯æ˜¾ç¤ºå™¨",
            "1680x1050 (16:10) ä¸­ç­‰åˆ†è¾¨ç‡",
            "3440x1440 (21:9) è¶…å®½å±",
            "2560x1080 (21:9) è¶…å®½æ¸¸æˆ",
            "5120x2880 (16:9) 5Kæ˜¾ç¤ºå™¨",
            "1024x768 (4:3) ç»å…¸æ¯”ä¾‹",
            "1280x1024 (5:4) æ¥è¿‘æ­£æ–¹å½¢",
            "1440x900 (8:5) Macé£æ ¼",
            "1200x1600 (3:4) ç«–å±æ˜¾ç¤ºå™¨",
            "1080x1920 (9:16) ç«–å±æ˜¾ç¤ºå™¨",
            
            # === æ¸¸æˆå¸¸ç”¨åˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === æ¸¸æˆå¸¸ç”¨åˆ†è¾¨ç‡ ===",
            "1280x960 (4:3) CSç»å…¸",
            "1440x1080 (4:3) æ‹‰ä¼¸4:3",
            "2048x1536 (4:3) iPad Proåˆ†è¾¨ç‡",
            
            # === è‰ºæœ¯åˆ›ä½œåˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === è‰ºæœ¯åˆ›ä½œåˆ†è¾¨ç‡ ===",
            "512x724 (âˆš2:1) SD1.5 A4ç«–ç‰ˆ",
            "724x512 (1:âˆš2) SD1.5 A4æ¨ªç‰ˆ",
            "1024x1448 (âˆš2:1) SDXL A4ç«–ç‰ˆ",
            "1448x1024 (1:âˆš2) SDXL A4æ¨ªç‰ˆ",
            "512x829 (Ï†:1) SD1.5 é»„é‡‘ç«–ç‰ˆ",
            "829x512 (1:Ï†) SD1.5 é»„é‡‘æ¨ªç‰ˆ",
            "1024x1658 (Ï†:1) SDXL é»„é‡‘ç«–ç‰ˆ",
            "1658x1024 (1:Ï†) SDXL é»„é‡‘æ¨ªç‰ˆ",
            "512x683 (3:4) SD1.5 ç»å…¸ç«–ç‰ˆ",
            "683x512 (4:3) SD1.5 ç»å…¸æ¨ªç‰ˆ",
            "1200x1800 (2:3) å°åˆ·ç«–ç‰ˆ",
            "1800x1200 (3:2) å°åˆ·æ¨ªç‰ˆ",
            
            # === ç¤¾äº¤åª’ä½“åˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === ç¤¾äº¤åª’ä½“åˆ†è¾¨ç‡ ===",
            "1080x1080 (1:1) Instagramæ­£æ–¹å½¢",
            "1080x1350 (4:5) Instagramç«–ç‰ˆ",
            "1080x1920 (9:16) TikTokç«–å±",
            "1920x1080 (16:9) YouTubeæ¨ªå±",
            
            # === è§†é¢‘åˆ¶ä½œåˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === è§†é¢‘åˆ¶ä½œåˆ†è¾¨ç‡ ===",
            "1920x1080 (16:9) Full HDè§†é¢‘",
            "1280x720 (16:9) HDè§†é¢‘",
            "3840x2160 (16:9) 4Kè§†é¢‘",
            "2560x1440 (16:9) 2Kè§†é¢‘",
            "1280x1280 (1:1) æ­£æ–¹å½¢è§†é¢‘",
            "720x1280 (9:16) ç«–å±çŸ­è§†é¢‘",
            
            # === iPhoneè®¾å¤‡åˆ†è¾¨ç‡ ===
            "ğŸŸ¢ === iPhoneæ—©æœŸç³»åˆ— (2G-4s) ===",
            "320x480 (2:3) iPhoneæ—©æœŸç«–å±",
            "480x320 (3:2) iPhoneæ—©æœŸæ¨ªå±",
            "640x960 (2:3) iPhone4/4sç«–å±", 
            "960x640 (3:2) iPhone4/4sæ¨ªå±",
            
            "ğŸŸ¢ === iPhone 5ç³»åˆ— ===",
            "640x1136 (9:16) iPhone5ç³»åˆ—ç«–å±",
            "1136x640 (16:9) iPhone5ç³»åˆ—æ¨ªå±",
            
            "ğŸŸ¢ === iPhone 6-8ç³»åˆ— ===",
            "752x1336 (9:16) iPhone6/7/8ç«–å±",
            "1336x752 (16:9) iPhone6/7/8æ¨ªå±",
            "1080x1920 (9:16) iPhone6/7/8 Plusç«–å±",
            "1920x1080 (16:9) iPhone6/7/8 Plusæ¨ªå±",
            
            "ğŸŸ¢ === iPhone Xç³»åˆ— ===",
            "576x1248 (9:19.5) iPhoneX/XSç«–å±ç¼©æ”¾",
            "1248x576 (19.5:9) iPhoneX/XSæ¨ªå±ç¼©æ”¾",
            "832x1792 (9:19.5) iPhoneXR/11ç«–å±",
            "1792x832 (19.5:9) iPhoneXR/11æ¨ªå±",
            
            "ğŸŸ¢ === iPhone 12ç³»åˆ— ===",
            "1080x2344 (9:19.5) iPhone12/13miniç«–å±",
            "2344x1080 (19.5:9) iPhone12/13miniæ¨ªå±",
            "1176x2536 (9:19.5) iPhone12/13/Proç«–å±",
            "2536x1176 (19.5:9) iPhone12/13/Proæ¨ªå±",
            "1288x2784 (9:19.5) iPhone12/13ProMaxç«–å±",
            "2784x1288 (19.5:9) iPhone12/13ProMaxæ¨ªå±",
            
            "ğŸŸ¢ === iPhone 14ç³»åˆ— ===",
            "1184x2560 (9:19.5) iPhone14/15ç«–å±",
            "2560x1184 (19.5:9) iPhone14/15æ¨ªå±",
            "1296x2800 (9:19.5) iPhone14/15Plusç«–å±",
            "2800x1296 (19.5:9) iPhone14/15Plusæ¨ªå±",
            
            "ğŸŸ¢ === iPhone 16ç³»åˆ— ===",
            "1208x2624 (9:19.5) iPhone16Proç«–å±",
            "2624x1208 (19.5:9) iPhone16Proæ¨ªå±",
            "1320x2872 (9:19.5) iPhone16ProMaxç«–å±",
            "2872x1320 (19.5:9) iPhone16ProMaxæ¨ªå±",
            
            "ğŸŸ¢ === iPhone SEç³»åˆ— ===",
            "640x1136 (9:16) iPhoneSE1ç«–å±",
            "1136x640 (16:9) iPhoneSE1æ¨ªå±",
            "752x1336 (9:16) iPhoneSE2/3ç«–å±",
            "1336x752 (16:9) iPhoneSE2/3æ¨ªå±",
        ]
        
        return {
            "required": {
                "mode": (["é¢„è®¾åˆ†è¾¨ç‡", "è‡ªå®šä¹‰å°ºå¯¸"], {
                    "default": "é¢„è®¾åˆ†è¾¨ç‡"
                }),
                "resolution_preset": (resolution_presets, {
                    "default": "1024x1024 (1:1) SDXL æ­£æ–¹å½¢"
                }),
                "width": ("INT", {
                    "default": 1024, 
                    "min": 64, 
                    "max": 8192, 
                    "step": 8
                }),
                "height": ("INT", {
                    "default": 1024, 
                    "min": 64, 
                    "max": 8192, 
                    "step": 8
                }),
                "batch_size": ("INT", {
                    "default": 1, 
                    "min": 1, 
                    "max": 4096
                }),
            }
        }

    RETURN_TYPES = ("LATENT",)
    FUNCTION = "generate"
    CATEGORY = "latent"

    def generate(self, mode, resolution_preset, width, height, batch_size=1):
        """
        æ ¹æ®é€‰æ‹©çš„æ¨¡å¼ç”Ÿæˆç©ºçš„latentå›¾åƒ
        æ”¯æŒé¢„è®¾åˆ†è¾¨ç‡å’Œè‡ªå®šä¹‰å°ºå¯¸ä¸¤ç§æ¨¡å¼
        """
        if mode == "é¢„è®¾åˆ†è¾¨ç‡":
            # æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†åˆ†ç±»æ ‡é¢˜
            if resolution_preset.startswith("ğŸŸ¢ ==="):
                # å¦‚æœé€‰ä¸­äº†åˆ†ç±»æ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤åˆ†è¾¨ç‡
                final_width, final_height = 1024, 1024
                print(f"è­¦å‘Š: é€‰ä¸­äº†åˆ†ç±»æ ‡é¢˜ '{resolution_preset}', ä½¿ç”¨é»˜è®¤åˆ†è¾¨ç‡ 1024x1024")
            else:
                # ä½¿ç”¨é¢„è®¾åˆ†è¾¨ç‡æ¨¡å¼
                try:
                    # è§£ææ ¼å¼ï¼š"1024x1024 (1:1) SDXL æ­£æ–¹å½¢"
                    resolution_part = resolution_preset.split(' ')[0]  # è·å– "1024x1024"
                    final_width, final_height = map(int, resolution_part.split('x'))
                except (ValueError, IndexError):
                    # å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    final_width, final_height = 1024, 1024
                    print(f"è­¦å‘Š: è§£æåˆ†è¾¨ç‡å¤±è´¥ '{resolution_preset}', ä½¿ç”¨é»˜è®¤åˆ†è¾¨ç‡ 1024x1024")
        else:
            # ä½¿ç”¨è‡ªå®šä¹‰å°ºå¯¸æ¨¡å¼
            final_width, final_height = width, height
            
        # ç¡®ä¿å°ºå¯¸æ˜¯8çš„å€æ•°ï¼ˆVAEè¦æ±‚ï¼‰
        final_width = (final_width // 8) * 8
        final_height = (final_height // 8) * 8
        
        # ç”Ÿæˆç©ºçš„latentå¼ é‡
        # Latentç©ºé—´çš„å°ºå¯¸æ˜¯å›¾åƒå°ºå¯¸çš„1/8
        latent_width = final_width // 8
        latent_height = final_height // 8
        
        # åˆ›å»ºç©ºçš„latentå¼ é‡ [batch_size, channels, height, width]
        latent = torch.zeros([batch_size, 4, latent_height, latent_width])
        
        return ({"samples": latent}, )

    @classmethod
    def IS_CHANGED(s, mode, resolution_preset, width, height, batch_size):
        """
        å½“è¾“å…¥å‚æ•°æ”¹å˜æ—¶é‡æ–°ç”Ÿæˆ
        """
        return f"{mode}_{resolution_preset}_{width}_{height}_{batch_size}" 